# Bulk Product Import Feature - Implementation Plan

## Overview
Add bulk product import functionality via CSV/XLSX files with intelligent column mapping, validation, and error handling.

## User Requirements Confirmed
- **UI Approach**: Modal/Dialog from products page
- **Missing References**: User can choose per import (auto-create vs. set to null)
- **Error Handling**: Show preview with errors, user confirms before import

---

## Phase 1: Backend - Install Dependencies

### Files to Modify
- `virtual_card/backend/package.json`

### Libraries to Install
```bash
npm install csv-parser xlsx
npm install -D @types/multer @types/csv-parser
```

| Library | Purpose |
|---------|---------|
| `csv-parser` | Parse CSV files in backend |
| `xlsx` | Parse Excel files in backend |

---

## Phase 2: Backend - Create Bulk Import Service

### New Files to Create

#### 1. `src/services/bulkProductImport.ts`
Core service for handling bulk import logic:

```typescript
interface ColumnMapping {
  userColumn: string;
  systemField: string;
}

interface ImportRow {
  rowNumber: number;
  data: any;
  errors: string[];
  warnings: string[];
}

interface ImportResult {
  totalRows: number;
  validRows: number;
  errorRows: number;
  skippedRows: number;
  products: any[];
  errors: ImportRow[];
}

interface ImportOptions {
  autoCreateBrands: boolean;
  autoCreateCategories: boolean;
  defaultQuantity?: number;
  defaultCurrency?: string;
}
```

**Key Methods:**
- `parseFile(buffer: Buffer, fileType: 'csv' | 'xlsx')` - Parse uploaded file
- `detectColumns(headers: string[])` - Auto-detect column mappings using fuzzy matching
- `validateRows(rows: any[], mapping: ColumnMapping[])` - Validate all rows
- `transformRow(row: any, mapping: ColumnMapping[])` - Transform user data to product schema
- `importProducts(rows: ImportRow[], options: ImportOptions)` - Batch insert to database

---

## Phase 3: Backend - Create Bulk Import Routes

### File to Modify
- `src/routes/userProduct.ts` - Add bulk import endpoints

### New Endpoints

#### 1. POST `/api/userProduct/import/upload`
Upload CSV/XLSX file and return parsed data with column detection.

**Request:**
```typescript
FormData {
  file: File;
  company: string;
}
```

**Response:**
```typescript
{
  headers: string[];
  rows: any[];
  detectedMappings: { userColumn: string; systemField: string; confidence: number }[];
  totalRows: number;
}
```

#### 2. POST `/api/userProduct/import/validate`
Validate data with user's column mapping and options.

**Request:**
```typescript
{
  mappings: ColumnMapping[];
  rows: any[];
  options: ImportOptions;
  company: string;
}
```

**Response:**
```typescript
{
  totalRows: number;
  validRows: number;
  errorRows: number;
  errors: ImportRow[];
  warnings: ImportRow[];
  preview: any[]; // First 10 transformed rows
}
```

#### 3. POST `/api/userProduct/import/execute`
Execute the actual import after user confirmation.

**Request:**
```typescript
{
  mappings: ColumnMapping[];
  rows: any[];
  options: ImportOptions;
  company: string;
  skipRows?: number[]; // Row indices to skip
}
```

**Response:**
```typescript
{
  success: boolean;
  created: number;
  skipped: number;
  failed: number;
  products: any[];
  errors: any[];
}
```

#### 4. GET `/api/userProduct/import/template`
Download CSV template with correct column names.

---

## Phase 4: Frontend - Install Dependencies

### File to Modify
- `virtual_card/client/package.json`

### Libraries to Install
```bash
npm install papaparse xlsx
npm install -D @types/papaparse
```

| Library | Purpose |
|---------|---------|
| `papaparse` | Parse CSV files in browser for preview |
| `xlsx` | Parse Excel files in browser for preview |

---

## Phase 5: Frontend - Create Import Service

### New File to Create
- `src/app/services/bulk-import.service.ts`

**Key Methods:**
```typescript
class BulkImportService {
  uploadFile(file: File, company: string): Observable<UploadResponse>
  validateImport(request: ValidateRequest): Observable<ValidationResponse>
  executeImport(request: ExecuteRequest): Observable<ImportResult>
  downloadTemplate(): void
}
```

---

## Phase 6: Frontend - Create Import Modal Component

### New Files to Create

#### 1. `src/app/components/bulk-product-import-modal/bulk-product-import-modal.component.ts`
Main modal component with multi-step wizard.

#### 2. `src/app/components/bulk-product-import-modal/bulk-product-import-modal.component.html`
Modal template with steps:
- Step 1: File Upload
- Step 2: Column Mapping
- Step 3: Validation & Options
- Step 4: Preview & Confirm

#### 3. `src/app/components/bulk-product-import-modal/bulk-product-import-modal.component.scss`
Modal styles following Angular Material patterns.

### Modal States

```
┌─────────────────────────────────────────────────────────────┐
│  Bulk Import Products                          [X]           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Step 1: Upload File                                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         Drag & drop CSV/XLSX file here              │   │
│  │              or click to browse                     │   │
│  │                                                        │   │
│  │  [Download Template]                                 │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ─────────────────────────────────────────────────────────  │
│                                                              │
│  Step 2: Map Columns (shown after upload)                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Your Column          ───►  System Field              │   │
│  │  ─────────────            ─────────────               │   │
│  │  [Product Name   ]  ───►  [name          ▼] ✓         │   │
│  │  [Price          ]  ───►  [price         ▼] ✓         │   │
│  │  [SKU Code       ]  ───►  [productSlug   ▼] ✓         │   │
│  │  [Img            ]  ───►  [media         ▼] ⚠         │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ─────────────────────────────────────────────────────────  │
│                                                              │
│  Step 3: Options & Validation                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Missing brands:    [Auto-create ▼]                   │   │
│  │  Missing categories: [Auto-create ▼]                   │   │
│  │                                                        │   │
│  │  Validation Results:                                  │   │
│  │  • 95 rows valid ✓                                     │   │
│  │  • 5 rows have issues:                                 │   │
│  │    - Row 12: Missing price                            │   │
│  │    - Row 27: Unknown brand "XYZ"                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ─────────────────────────────────────────────────────────  │
│                                                              │
│  Step 4: Preview & Confirm                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Import Summary:                                      │   │
│  │  • Total rows: 100                                    │   │
│  │  • Will create: 95 products                           │   │
│  │  • Will skip: 5 rows                                  │   │
│  │                                                        │   │
│  │  [Start Import] [Cancel]                              │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## Phase 7: Frontend - Update Products Page

### File to Modify
- `src/app/modules/user-products/user-products.component.ts`

### Changes
1. Add "Bulk Import" button to toolbar
2. Open import modal on button click
3. Refresh product list after successful import

---

## Phase 8: Data Transformation Logic

### Column Aliases for Auto-Matching

```typescript
const COLUMN_ALIASES = {
  name: ['name', 'product_name', 'product name', 'title', 'item', 'product title'],
  price: ['price', 'cost', 'amount', 'selling price', 'unit price'],
  originalPrice: ['original_price', 'msrp', 'list price', 'retail price'],
  quantity: ['quantity', 'qty', 'stock', 'inventory', 'available quantity'],
  productSlug: ['slug', 'product_slug', 'sku', 'product code', 'item code'],
  media: ['image', 'image url', 'picture', 'photo', 'img', 'media url'],
  description: ['description', 'desc', 'details', 'product description'],
  brand: ['brand', 'manufacturer', 'maker', 'brand name'],
  category: ['category', 'cat', 'product category', 'type'],
  tags: ['tags', 'keywords', 'labels'],
  currency: ['currency', 'ccy'],
  virtual: ['virtual', 'is_virtual', 'digital'],
  shippingPrice: ['shipping', 'shipping_price', 'delivery'],
  tax: ['tax', 'tax_rate', 'vat']
};
```

### Data Normalizers

```typescript
// Price: Handle "$1,299.00", "1299", "1.299,00"
normalizePrice(value): number

// Quantity: Handle "100", "100 pcs", "Out of Stock", "N/A"
normalizeQuantity(value): number

// Media: Handle single URL, comma-separated URLs
normalizeMedia(value): { src: string; alt?: string }[]

// Slug: Auto-generate from name if missing
slugify(text): string
```

---

## Phase 9: Error Handling & Validation

### Backend Validation Rules

| Field | Validation | Default |
|-------|-----------|---------|
| name | Required, non-empty | - |
| price | Required, number > 0 | - |
| productSlug | Required, unique per company | Auto from name |
| originalPrice | Required | Same as price |
| quantity | Required | 0 |
| quantityUntracked | Required | true |
| publish | Required | true |
| media | At least one src | Placeholder |
| brand | Must exist or auto-create | null |
| category | Must exist or auto-create | null |
| virtual | Required | false |

### Error Response Format
```typescript
{
  rowNumber: 5,
  errors: [
    { field: 'price', message: 'Price is required and must be a number' }
  ],
  warnings: [
    { field: 'brand', message: 'Brand "Nike" will be created' }
  ]
}
```

---

## Phase 10: Testing & Verification

### Backend Tests
1. Upload CSV file → Should return parsed data
2. Upload Excel file → Should return parsed data
3. Auto-detect columns → Should match common variations
4. Validate with missing required fields → Should return errors
5. Import with auto-create brands → Should create brands
6. Import with set-null option → Should set null
7. Partial import (some valid, some invalid) → Should import valid only

### Frontend Tests
1. Open modal → Should display upload screen
2. Upload file → Should show column mapping step
3. Change mappings → Should update validation
4. Show preview → Should display summary
5. Execute import → Should show progress and results
6. Close modal → Should refresh product list

### End-to-End Test
1. Navigate to products page
2. Click "Bulk Import" button
3. Upload sample CSV file
4. Review and adjust column mappings
5. Set import options
6. Review validation results
7. Confirm import
8. Verify products created in database
9. Verify product list refreshed

---

## Critical Files Summary

### Backend
| File | Action |
|------|--------|
| `package.json` | Add dependencies |
| `src/services/bulkProductImport.ts` | Create new |
| `src/routes/userProduct.ts` | Add 3 new endpoints |
| `src/middlewares/upload/index.ts` | May extend for CSV/XLSX |

### Frontend
| File | Action |
|------|--------|
| `package.json` | Add dependencies |
| `src/app/services/bulk-import.service.ts` | Create new |
| `src/app/components/bulk-product-import-modal/` | Create new component |
| `src/app/modules/user-products/user-products.component.ts` | Add import button |

---

## Implementation Order

1. Backend dependencies installation
2. Backend service (`bulkProductImport.ts`)
3. Backend routes (add to `userProduct.ts`)
4. Frontend dependencies installation
5. Frontend service (`bulk-import.service.ts`)
6. Frontend modal component (all 3 files)
7. Update products page with import button
8. Testing and refinement
